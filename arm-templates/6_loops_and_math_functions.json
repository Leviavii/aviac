{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "storageAccountCount": {
      "type": "int",
      "defaultValue": 3,
      "minValue": 1,
      "maxValue": 5
    },
    "baseStorageSize": {
      "type": "int",
      "defaultValue": 100
    },
    "multiplier": {
      "type": "int",
      "defaultValue": 2
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    }
  },
  "variables": {
    "storageAccountPrefix": "storage",
    "maxStorageSize": "[mul(parameters('baseStorageSize'), parameters('multiplier'))]",
    "totalCost": "[add(variables('maxStorageSize'), div(parameters('storageAccountCount'), 2))]",
    "discountThreshold": "[sub(variables('maxStorageSize'), 50)]",
    "storageSkuBasedOnCount": "[if(greater(parameters('storageAccountCount'), 2), 'Standard_GRS', 'Standard_LRS')]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-04-01",
      "name": "[concat(variables('storageAccountPrefix'), copyIndex(1), uniqueString(resourceGroup().id, string(copyIndex())))]",
      "location": "[parameters('location')]",
      "copy": {
        "name": "storageLoop",
        "count": "[parameters('storageAccountCount')]"
      },
      "sku": {
        "name": "[variables('storageSkuBasedOnCount')]"
      },
      "kind": "StorageV2",
      "properties": {
        "accessTier": "[if(equals(mod(copyIndex(), 2), 0), 'Hot', 'Cool')]"
      },
      "tags": {
        "Index": "[string(copyIndex())]",
        "StorageNumber": "[string(copyIndex(1))]",
        "CalculatedSize": "[string(add(variables('maxStorageSize'), mul(copyIndex(), 10)))]",
        "IsEven": "[string(equals(mod(copyIndex(), 2), 0))]"
      }
    },
    {
      "condition": "[greater(parameters('storageAccountCount'), 1)]",
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2021-04-01",
      "name": "[concat(variables('storageAccountPrefix'), '1', uniqueString(resourceGroup().id, '0'), '/default')]",
      "dependsOn": [
        "storageLoop"
      ],
      "properties": {
        "deleteRetentionPolicy": {
          "enabled": true,
          "days": "[add(7, mul(parameters('storageAccountCount'), 3))]"
        }
      }
    }
  ],
  "outputs": {
    "createdStorageCount": {
      "type": "int",
      "value": "[parameters('storageAccountCount')]"
    },
    "maxStorageSize": {
      "type": "int",
      "value": "[variables('maxStorageSize')]"
    },
    "totalCalculatedCost": {
      "type": "int",
      "value": "[variables('totalCost')]"
    },
    "discountApplies": {
      "type": "bool",
      "value": "[greater(variables('totalCost'), variables('discountThreshold'))]"
    },
    "storageAccountNames": {
      "type": "array",
      "copy": {
        "count": "[parameters('storageAccountCount')]",
        "input": "[concat(variables('storageAccountPrefix'), copyIndex('storageAccountNames', 1), uniqueString(resourceGroup().id, string(copyIndex('storageAccountNames'))))]"
      }
    }
  }
}
